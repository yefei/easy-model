#!/usr/bin/env node

'use strict';

const fs = require('fs');
const path = require('path');
const mysql = require('mysql2');
const { Query } = require('mysql-easy-query');

if (process.argv[2] !== 'gen' || !process.argv[3]) {
  console.log('zenorm gen config.json');
  process.exit();
}

const config = Object.assign({}, require(path.join(process.cwd(), process.argv[3]))); 
const requireName = process.env.ZENORM_MODULE_NAME || 'zenorm';
const modelsOptionsDir = path.resolve(process.cwd(), config.optionsDir || 'models_options');
const tsFilename = config.typingFile || 'models.d.ts';
const tsFile = path.resolve(process.cwd(), tsFilename);
const modelsFilename = config.modelsFile || 'models.js';
const modelsFile = path.resolve(process.cwd(), modelsFilename);
let tsRelative = path.relative(modelsFile, tsFile).replace(/\\/g, '/').substring(3);
if (!tsRelative.startsWith('../')) tsRelative = `./${tsRelative}`;
tsRelative = tsRelative.slice(0, -5); // remove .d.ts

const conn = mysql.createConnection({
  host: config.host || 'localhost',
  port: config.port || 3306,
  user: config.user || 'root',
  password: config.password,
  database: config.database,
});

const query = new Query(conn);

/**
 * @param {string} type
 */
function getColumnType(type) {
  if (type.search(/timestamp|datetime/i) != -1) return 'Date';
  if (type.search(/int|float/i) != -1) return 'number';
  return 'string';
}

/**
 * @param {string} name
 */
function nameCase(name) {
  return name.split('_').map(c => c[0].toUpperCase() + c.substring(1)).join('');
}

/**
 * @param {string} filename
 */
function checkFileDir(filename) {
  const dir = path.dirname(filename);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir);
  }
}

async function main() {
  console.log('get tables...');
  const tables = await query.query('SHOW TABLES');
  const remark = [
    '// zenorm auto generate',
    '// This file is automatically generated',
    '// Please do not modify',
    `// date: ${new Date().toLocaleString()}`,
    `// user: ${process.env.USER || process.env.USERNAME || 'unknown'}@${process.env.COMPUTERNAME || 'unknown'}`,
    `// database: ${config.database}`,
  ];
  const out = [
    ...remark,
    '',
    `import { Instance, Model, Query } from '${requireName}';`,
    '',
  ];
  const modelJs = [
    "'use strict';",
    ...remark,
    '/**',
    ` * @typedef {import('${requireName}').Query} Query`,
    ' */',
    '',
    `const { Model } = require('${requireName}');`,
    '',
  ];
  const optionsJs = [
    `function loadModelOption(c, p) { try { require.resolve(p); } catch (e) { return; } Object.assign(c, require(p)); }`,
  ];
  const queriesTs = [];
  const queriesJs = [];
  for (const t of tables) {
    const tableName = t[`Tables_in_${config.database}`];
    const className = nameCase(tableName);
    console.log('table:', tableName);
    const columns = await query.query('SHOW FULL COLUMNS FROM ??', [tableName]);
    let pk;
    out.push(`/**`);
    out.push(` * table: ${tableName}`);
    out.push(` */`);
    out.push(`export declare class ${className}Instance extends Instance {`);
    for (const c of columns) {
      if (!pk && c.Key === 'PRI') pk = c.Field;
      out.push(`  /**`);
      c.Comment && out.push(`   * ${c.Comment}`);
      out.push(`   * ${c.Type} ${c.Extra}`);
      out.push(`   */`);
      out.push(`  ${c.Field}: ${getColumnType(c.Type)};`);
    }
    out.push(`}`);
    out.push(``);
    out.push(`export declare class ${className}Model extends Model<${className}Instance> {}`);
    out.push(`export declare function ${className}Query(query: Query): ${className}Model;`);
    out.push(``);

    // options
    const optionFilename = path.join(modelsOptionsDir, `${tableName}.js`);
    let optionRelative = path.relative(modelsFile, optionFilename).replace(/\\/g, '/').substring(3);
    if (!optionRelative.startsWith('../')) optionRelative = `./${optionRelative}`;
    optionRelative = optionRelative.slice(0, -3); // remove .js
    optionsJs.push(`loadModelOption(${className}Option, '${optionRelative}');`);

    // js
    modelJs.push(`const ${className}Option = { name: '${tableName}', table: '${tableName}', pk: '${pk}' };`);
    modelJs.push(`/** @type { import('${tsRelative}').${className}Query } */`);
    modelJs.push(`exports.${className}Query = query => new Model(${className}Option, query);`);
    modelJs.push(``);

    // queries
    const prop = `${className.charAt(0).toLowerCase()}${className.slice(1)}`;
    queriesTs.push(`  ${prop}: ${className}Model;`);
    queriesJs.push(`  get ${prop}() { return exports.${className}Query(this._query); }`);
  }

  // queries
  out.push(`export declare class Queries {`);
  out.push(`  constructor(query: Query);`);
  out.push(...queriesTs);
  out.push(`}`);
  out.push(``);
  out.push(`export declare function queries(query: Query): Queries;`);
  out.push(``);

  modelJs.push(`class Queries {`);
  modelJs.push(`  /**`);
  modelJs.push(`   * @param {Query} query`);
  modelJs.push(`   */`);
  modelJs.push(`  constructor(query) { this._query = query; }`);
  modelJs.push(...queriesJs);
  modelJs.push(`}`);
  modelJs.push(`exports.Queries = Queries;`);
  modelJs.push(``);

  modelJs.push(`/**`);
  modelJs.push(` * @param {Query} query`);
  modelJs.push(` */`);
  modelJs.push(`exports.queries = function(query) { return new Queries(query); };`);
  modelJs.push(``);

  if (optionsJs.length) {
    modelJs.push(`/* options update */`);
    modelJs.push(...optionsJs);
    modelJs.push(``);
  }

  console.log(`write types file: ${tsFile}`);
  checkFileDir(tsFile);
  fs.writeFileSync(tsFile, out.join('\n'));

  console.log(`write models file: ${modelsFile}`);
  checkFileDir(modelsFile);
  fs.writeFileSync(modelsFile, modelJs.join('\n'));
}

function help() {
  console.log('Create config file: dbgen.json');
  console.log('Write optional configuration items:');
  console.log('MYSQL_HOST=localhost');
  console.log('MYSQL_PORT=3306');
  console.log('MYSQL_USER=root');
  console.log('MYSQL_PASSWORD=');
  console.log('MYSQL_DATABASE=');
  console.log('INPUT_OPTIONS_DIR=models_options');
  console.log('OUTPUT_TYPES_FILE=models.d.ts');
  console.log('OUTPUT_MODELS_FILE=models.js');
}

main().catch(e => {
  console.log(e);
  console.log('='.repeat(100));
  console.log('Execution failed....');
}).finally(() => process.exit());
setInterval(() => {}, 1000);
